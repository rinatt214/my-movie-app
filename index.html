<!DOCTYPE html>
<html lang = "en">
<head>      
    <meta charset = "UTF-8">
    <title>电影推荐</title>
    <!-- 上面是网页的基本设置，比如编码和标题 -->
    <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 40px auto;
                padding: 0 20px;
                background-color: #f9f9f9;
                color: #333;
            }
            h1 {
                    text-align: center;
                    margin-bottom: 30px;
            }

            #movie-container{
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    padding: 20px;
                    margin-bottom: 20px;
            }

            #movie-container h2{
                    margin-top: 0;
            }

            button:hover{
                    background-color: #0056b3;
            }

            #recommendation{
                    background: #fff7e6;
                    border: 1px solid #ffe58f;
                    border-radius: 8px;
                    padding: 15px;
            }
    </style>
</head>
<body>
<!-- 以后我们要把电影列表、按钮这些放在这里 -->
        <h1>欢迎使用电影推荐系统</h1>
        <!--展示电影信息的容器-->
        <div id="movie-container"></div>

        <!--选择按钮-->
        <div id="choice-buttons" style="margin-top: 20px;">
                <button onclick="handleChoice('Like')">Like</button>
                <button onclick="handleChoice('Dislike')">DisLike</button>
                <button onclick="handleChoice('Dont know')">DontKnow</button>
        </div>

        <button onclick="clearChoices()" style="background-color: red; margin-top: 20px">清除历史记录</button>
        <button onclick="toggleFavorite()">收藏</button>
        <div id="favorite-list" style="margin-top: 30px;"></div>

        <!--推荐区域-->
        <div id="recommendation" style="margin-top: 30px;"></div>
        <button onclick="recommendMore()" style="margin-top: 15px;">再推荐一部</button>

        <script>
        let movies = [];
        let selectedMovies = [];        //最终展示的10部电影
        let currentIndex = 0;           //当前展示的第几部
        let recommendedMovies = [];     //存放已推荐的电影名
        let userChoices = JSON.parse(localStorage.getItem("userChoices") || "{}");           //用户选择结果{电影名：喜好}
        let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        let genreMap = {};              //用于存储TMDB类型ID对应的中文名称

        async function fetchGenreMap(){
                const apiKey = "c0561d7828841c2b8dfa1741c3cc345d";
                const url = `https://api.themoviedb.org/3/genre/movie/list?api_key=${apiKey}&language=zh-CN`;

                try{
                        const res = await fetch(url);
                        const data = await res.json();
                        data.genres.forEach(genre => {
                                genreMap[genre.id] = genre.name;
                        });
                }catch(err){
                        console.error("获取类型失败", err);
                }
        }

        //加载TMDB数据
        async function fetchMoviesFromTMDB(){
                const apiKey = "c0561d7828841c2b8dfa1741c3cc345d";
                const url = `https://api.themoviedb.org/3/movie/popular?api_key=${apiKey}&language=zh-CN&page=1`;

                try{
                        const res = await fetch(url);
                        const data = await res.json();

                        //转换数据机构为系统所需要的格式
                        movies = data.results.map(movie => ({
                                name: movie.title || "未命名",
                                rating: movie.vote_average || "无评分",
                                genre: movie.genre_ids?.map(id => genreMap[id]).join(" / ") || "未知",
                                description: movie.overview || "暂无简介",
                                country: "未知",
                                language: "未知",
                                year: movie.release_data?.split("-")[0] || "未知",
                                poster: movie.poster_path?`https://image.tmdb.org/t/p/w500${movie.poster_path}`: null
                        }));

                        //启动推荐流程
                        selectedMovies = getRandomMovies();
                        showCurrentMovie();

                }catch(error){
                        console.error("获取电影数据失败:", error);
                }
        }

        //打乱电影列表并取前10部
        function getRandomMovies(){
                const shuffled = [...movies].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, 10);
        }

        //显示当前电影
        function showCurrentMovie(){
                const movie = selectedMovies[currentIndex];
                const container = document.getElementById("movie-container");
                container.innerHTML = `
                  <img src="${movie.poster}" alt="封面图" style="max-width: 200px; border-radius: 10px; margin-bottom: 10px;">
                  <h2>${movie.name} (${movie.year})</h2>
                  <p>评分: ${movie.rating} | 类型: ${movie.genre} | 国家: ${movie.country}</p>
                  <p>${movie.description}</p>
                `;
        }

        //处理按钮点击
        function handleChoice(feedback){
                const movie = selectedMovies[currentIndex];
                userChoices[movie.name] = feedback;
                localStorage.setItem("userChoices", JSON.stringify(userChoices));
                currentIndex++;

                if(currentIndex < selectedMovies.length){
                        showCurrentMovie();     //显示下一部
                }else{
                        document.getElementById("movie-container").innerHTML = "<h2>初步选择完成！</h2>";
                        document.getElementById("choice-buttons").style.display = "none";
                        showRecommendation();   //显示推荐
                }
        }

        //推荐逻辑(根据用户喜欢的类型)
        function showRecommendation(){
                const likedGenres = [];

                for (let name in userChoices){
                        if(userChoices[name] === "Like"){
                                const genre = movies.find(m => m.name === name)?.genre;
                                if(genre && !likedGenres.includes(genre)){
                                        likedGenres.push(...genre.split(" / "));
                                }
                        }
                }

                if (likedGenres.length === 0){
                        document.getElementById("recommendation").innerText = "你还没有标记喜欢的电影，无法推荐";
                        return;
                }

                const candidates = movies.filter(m => likedGenres.some(type => m.genre.includes(type)) && !(m.name in userChoices));
                if(candidates.length > 0){
                        const rec = candidates[Math.floor(Math.random() * candidates.length)];
                        document.getElementById("recommendation").innerHTML = `
                                <img src="${rec.poster}" alt="封面图" style="max-width: 200px; border-radius: 10px; margin-bottom: 10px;">
                                <h3>推荐你看看:</h3>
                                <p><strong>${rec.name}</strong> (${rec.year}) | 评分: ${rec.rating} | 类型: ${rec.genre}</p>
                                <p>${rec.description}</p>
                              `;
                }else{
                        document.getElementById("recommendation").innerText = "没有更多可推荐的电影了，试试多选几个喜欢的！";    
                }
        }

        function toggleFavorite(){
                const movie = selectedMovies[currentIndex];
                const exists = favorites.find(f => f.name === movie.name);
        if(exists){
                //取消收藏
                favorites = favorites.find(f => f.name !== movie.name);
        }else{
                //添加收藏
                favorites.push(movie);
        }

        localStorage.setItem("favories", JSON.stringify(favorites));
        showFavorites();        //更新显示
        }

        function showFavorites(){
                const container = document.getElementById("favorite-list");

                if(favorites.lengh === 0){
                        container.innerHTML = "<h3>你还没有收藏任何电影</h3>";
                        return;
                }

                const html = favorites.map(movie => `<li>${movie.name} (${movie.year})｜${movie.genre}</li>`).join("");

                container.innerHTML = `
                        <h3>你收藏的电影:</h3>
                        <ul>${html}</ul>
                        `;     
        }

        //清楚历史记录
        function clearChoices(){
                localStorage.removeItem("userChoices");
                alert("已清除历史记录，请刷新页面重新开始！");
        }
        
        function recommendMore(){
                const likedGenres = [];

                for (let name in userChoices){
                        if(userChoices[name] === "Like"){
                                const genre = movies.find(m => m.name === name)?.genre;
                                if(genre && !likedGenres.includes(genre)){
                                        likedGenres.push(genre);
                                }
                        }
                }

                const candidates = movies.filter(m => likedGenres.includes(m.genre) && !(m.name in userChoices) && !recommendedMovies.includes(m.name));

                if(candidates.length > 0){
                        const rec = candidates[Math.floor(Math.random() * candidates.length)];
                        recommendedMovies.push(rec.name);       //标记已推荐
                        const recDiv = document.getElementById("recommendation");
                        recDiv.innerHTML += `
                        <div style = "margin-top: 10px; padding: 10px; border-top: 1px solid #ccc;">
                          <p><strong>${rec.name}</strong>(${rec.year}) | 评分：${rec.rating}｜类型：${rec.genre}</p>
                          <p>${rec.description}</p>
                        </div>
                      `;
                }else{
                        alert("没有更多电影可以推荐了!");
                }
        }

        //页面加载后启动流程
        window.onload = async() => {
                await fetchGenreMap();          //拉类型表
                await fetchMoviesFromTMDB();    //获取电影数据

                if(Object.keys(userChoices).length >= 10){
                        document.getElementById("movie-container").innerHTML = "<h2>欢迎回来！</h2>";
                        document.getElementById("choice-buttons").style.display = "none";
                        showRecommendation();
                }else{
                        selectedMovies = getRandomMovies();
                        showCurrentMovie();  
                }
                showFavorites();
        };

        </script>

</body>
</html>
<a href="about.html">关于本项目</a>